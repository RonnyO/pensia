<!doctype html>
<html lang="he" dir="rtl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>מחשבון פנסיה על בסיס המסלקה הפנסיונית</title>

    <link href="https://fonts.googleapis.com/icon?family=Rubik" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <!-- Bootstrap core CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://hamidheidarinia.github.io/bootstrap-rtl/4.2/assets/css/custom-rtl.min.css">
    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
    <link href="file-upload.css" rel="stylesheet">


    <!-- Custom styles for this template -->
    <style>
        body {
            font-size: 14px;
        }

        body,
        .card {
            background-color: #fff9f4;
        }

        body {
            font-family: Rubik, sans-serif !important
        }

        @media (min-width: 768px) {
            html {
                font-size: 16px;
            }
        }

        .container {
            max-width: 960px;
        }

        .pricing-header {
            max-width: 700px;
        }

        .card-deck .card {
            min-width: 220px;
        }

        .border-top {
            border-top: 1px solid #e5e5e5;
        }

        .border-bottom {
            border-bottom: 1px solid #e5e5e5;
        }

        .btn-xl {
            padding: 10px 20px;
            font-size: 20px;
            border-radius: 7px;
        }

        #calculations {
            display: none;
        }

        .display-4-5 {
            font-size: 3rem;
            font-weight: 300;
            line-height: 1.2;
        }

        #calculations div {
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <h1 class="display-3">מחשבון פנסיה</h1>
    </div>

    <div class="container">
        <form id="form">
            <div class="card-deck mb-3 text-center">
                <div class="card mb-4 border-0">
                    <div class="card-body">
                        <h3 class="card-title pricing-card-title">אני בן</h3>
                        <input type="number" name="current_age" class="form-control" autofocus required></input>
                    </div>
                </div>
                <div class="card mb-4 border-0">
                    <div class="card-body">
                        <h3 class="card-title pricing-card-title">התחלתי לעבוד בגיל</h3>
                        <input type="number" name="start_of_work_age" class="form-control" required></input>
                    </div>
                </div>
                <div class="card mb-4 border-0">
                    <div class="card-body">
                        <h3 class="card-title pricing-card-title">אני מרוויח</h3>
                        <input type="number" name="salary" class="form-control" required></input>
                    </div>
                </div>

                <div class="file-upload-wrapper mb-5" id="upload">
                    <input type="file" id="input-file-now" class="file-upload" />
                </div>
        </form>
    </div>

    <pre id="pre"></pre>

    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="mdb-file-upload.min.js"></script>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        var inputs = document.querySelectorAll('input[type=number]');

        for (input of inputs) {
            input.value = getCookie(input.name);

            input.addEventListener('input', function () {
                setCookie(input.name, input.value);
            }, false);
        }

        function getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        function setCookie(name, value, days = 999) {
            var d = new Date;
            d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * days);
            document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
        }

        $('.file-upload').file_upload({
            messages: {
                default: "תגרור לכאן את הקובץ אקסל שהורדתם מהמסלקה או תלחצו"
            },
            allowedFileExtensions: ["xls"],
            onFileUpload: handleDrop
        });

        function readColumnWiseData(range, ws) {
            var columnWiseData = [];
            for (var C = range.s.c; C <= range.e.c; ++C) {
                columnWiseData[C] = [];
                for (var R = range.s.r; R <= range.e.r; ++R) {

                    var cellref = XLSX.utils.encode_cell({ c: C, r: R });
                    if (!ws[cellref]) continue;
                    var cell = ws[cellref];
                    columnWiseData[C].push(cell.v);

                };
            }
            return columnWiseData;
        }

        function convertCSVToJSON(rows) {
            const titles = rows[0];

            return rows.slice(1).map(row => {
                const values = row;
                return titles.reduce((object, curr, i) => (object[curr] = values[i], object), {})
            });
        };

        function sheetToJson(sheet, skipRows = 2) {
            return convertCSVToJSON(readColumnWiseData(XLSX.utils.decode_range(`A${skipRows + 1}:${sheet['!ref'].split(':')[1]}`), sheet));
        }


        function handleDrop(input) {
            var files = input.files, f = files[0];
            if (!f.name.endsWith('.xls')) {
                alert('בבקשה תעלה את הקובץ ״פרטי המוצרים שלי.xls״');
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('upload').style.display = 'none'
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });

                window.w = workbook;
                window.p = [];
                pre = document.getElementById('pre');

                for (let sheet of Object.values(w.Sheets)) {
                    pre.innerText += (`${JSON.stringify(sheetToJson(sheet), 4, 4)}\n`);
                    window.p.push(...sheetToJson(sheet));
                }
            };
            reader.readAsArrayBuffer(f);
        }
        document.getElementById('upload').addEventListener('file_upload.fileReady', console.log, false);
        // document.getElementById('upload').addEventListener('drop', handleDrop, false);
    </script>
</body>

</html>